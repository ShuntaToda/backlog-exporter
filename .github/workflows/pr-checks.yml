name: Pull Request Checks

# Pull Requestä½œæˆãƒ»æ›´æ–°æ™‚ã«ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œ
on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®æ¨©é™è¨­å®š
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  quality-checks:
    name: å“è³ªãƒã‚§ãƒƒã‚¯
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
      - name: npm ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®è¨­å®š
        uses: actions/cache@v4
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      # Lintãƒã‚§ãƒƒã‚¯
      - name: Lintãƒã‚§ãƒƒã‚¯ã®å®Ÿè¡Œ
        id: lint
        run: npm run lint
        continue-on-error: true

      # ãƒ“ãƒ«ãƒ‰ç¢ºèª
      - name: ãƒ“ãƒ«ãƒ‰ã®ç¢ºèª
        id: build
        run: npm run build
        continue-on-error: true

      # ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆãƒã‚§ãƒƒã‚¯
      - name: ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ç¢ºèª
        id: format
        run: npm run format:check
        continue-on-error: true

      # ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
      - name: ãƒã‚§ãƒƒã‚¯çµæœã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        if: steps.lint.outcome == 'failure' || steps.build.outcome == 'failure' || steps.format.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const errors = [];

            if ('${{ steps.lint.outcome }}' === 'failure') {
              errors.push('### âš ï¸ Lintã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\n\n' +
                'ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ãƒ¼ã‚«ãƒ«ã§Lintã‚’å®Ÿè¡Œã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š\n```bash\nnpm run lint\n```\n\n');
            }

            if ('${{ steps.build.outcome }}' === 'failure') {
              errors.push('### âš ï¸ ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\n\n' +
                'ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š\n```bash\nnpm run build\n```\n\n');
            }

            if ('${{ steps.format.outcome }}' === 'failure') {
              errors.push('### âš ï¸ ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ\n\n' +
                'ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚³ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š\n```bash\nnpm run format\n```\n\n');
            }

            if (errors.length > 0) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: '## ğŸ” å“è³ªãƒã‚§ãƒƒã‚¯ã®çµæœ\n\n' + errors.join('\n') +
                  '\n\nä¿®æ­£å¾Œã€å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨è‡ªå‹•çš„ã«ãƒã‚§ãƒƒã‚¯ãŒå†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚'
              });
            }

      # å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒå¤±æ•—ã—ãŸå ´åˆã¯ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã•ã›ã‚‹
      - name: ãƒã‚§ãƒƒã‚¯çµæœã®ç¢ºèª
        if: steps.lint.outcome == 'failure' || steps.build.outcome == 'failure' || steps.format.outcome == 'failure'
        run: exit 1

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚’åˆ¥ã‚¸ãƒ§ãƒ–ã¨ã—ã¦ä¸¦åˆ—å®Ÿè¡Œ
  tests:
    name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Node.jsã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm

      - name: ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        run: npm ci

      # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      - name: ãƒ†ã‚¹ãƒˆã®å®Ÿè¡Œ
        id: test
        run: npm test
        continue-on-error: true

      # ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
      - name: ãƒ†ã‚¹ãƒˆçµæœã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
        if: steps.test.outcome == 'failure'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## âŒ ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ã¾ã—ãŸ\n\n' +
                'ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ãƒ­ãƒ¼ã‚«ãƒ«ã§ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦ä¿®æ­£ã—ã¦ãã ã•ã„ï¼š\n```bash\nnpm test\n```\n\n' +
                'ãƒ†ã‚¹ãƒˆã®è©³ç´°ãªãƒ­ã‚°ã‚’ç¢ºèªã—ã€å¤±æ•—ã—ãŸãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’ä¿®æ­£ã—ã¦ãã ã•ã„ã€‚\n\n' +
                'ä¿®æ­£å¾Œã€å†åº¦ãƒ—ãƒƒã‚·ãƒ¥ã™ã‚‹ã¨è‡ªå‹•çš„ã«ãƒ†ã‚¹ãƒˆãŒå†å®Ÿè¡Œã•ã‚Œã¾ã™ã€‚'
            });

      # ãƒ†ã‚¹ãƒˆãŒå¤±æ•—ã—ãŸå ´åˆã¯ã‚¸ãƒ§ãƒ–ã‚’å¤±æ•—ã•ã›ã‚‹
      - name: ãƒ†ã‚¹ãƒˆçµæœã®ç¢ºèª
        if: steps.test.outcome == 'failure'
        run: exit 1

  # å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ãŸå ´åˆã®é€šçŸ¥
  success-notification:
    name: æˆåŠŸé€šçŸ¥
    needs: [quality-checks, tests]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æŠ•ç¨¿
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '## âœ… å…¨ã¦ã®ãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸï¼\n\n' +
                'å“è³ªãƒã‚§ãƒƒã‚¯ã¨ãƒ†ã‚¹ãƒˆãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚\n\n' +
                'ãƒ¬ãƒ“ãƒ¥ã‚¢ãƒ¼ã¯ã“ã®Pull Requestã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ãã¾ã™ã€‚'
            });
